!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).om=(t="undefined"!=typeof globalThis?globalThis:t||self).om||{})}(this,(function(t){"use strict";function e(t){let e=t.filter((t=>"crossLines"!==t.type));for(var o=e.map((t=>function(t){var e=t.vectors[0];if(e.length<2)return;var o,s=null,n=[],r=0,a=null;return e.reduce(((t,h,l)=>{var u=h.clone().sub(t),c=u.length(),m=u.normalize();return r=function(t,e,o){if(o<1)return 0;e=e||i;var s=Math.sign(e.clone().cross(t).z);0===s&&(s=1);var n=180*e.angleTo(t)/Math.PI*s;return n}(m,s,c),o=function(t,e,i){if(i<1)return{text:"前",index:0};var o,s=Math.sign(t),n=["北",["西北","东北"],["西","东"],["西南","东南"],"南"],r=["前",["左前","右前"],["左","右"],["左后","右后"],"后"];o=e?r:n;var a,h=Math.abs(t)+22.5,l=Math.floor(h/45),u=o[l];a=Array.isArray(u)?u[s>0?0:1]:u;return{text:a,index:l*(l>0&&l<4?s>0?1:-1:1)}}(r,s,c),a||(a={text:o.text,distance:0,index:l-1,angleOffset:r,angle:180*(Math.atan2(m.y,m.x)-Math.PI/2)/Math.PI,direction:m,position:t}),0===o.index&&l<e.length-1||1===l?a.distance+=c:(l===e.length-1&&(a.distance+=c),n.push(a),a={text:o.text,distance:c,index:l-1,angleOffset:r,angle:180*(Math.atan2(m.y,m.x)-Math.PI/2)/Math.PI,direction:m,position:t},l===e.length-1&&0!==o.index&&n.push(a)),s=m,h})),n.floorNumber=t.floorNumber,n}(t))),s=0,n=o.length;s<n;s++){var r=e[s].vectors[0];s<n-1?o[s].push({text:e[s+1].floorNumber,floorNumber:e[s+1].floorNumber,index:e[s].vectors[0].length-1,position:r[r.length-1],type:"changeFloor"}):o[s].push({text:"终点",index:r.length-1,position:r[r.length-1],type:"terminal"})}return o}var i=new(globalThis.om||{}).thr.Vector3(0,1,0);var o=new om.thr.Vector3,s=new om.thr.Vector3,n=new om.thr.Vector3;class r{_length=0;constructor(t,e,i){this.points=[t,e],this.index=i}get length(){return this._length||(this._length=this.points[0].distanceTo(this.points[1])),this._length}closestPointToPointParameter(t,e=!0){o.subVectors(t,this.points[0]),s.subVectors(this.points[1],this.points[0]);var i=s.dot(s),n=s.dot(o)/i;return e&&(n=Math.min(1,Math.max(0,n))),n}closestPointToPoint(t,e,i=!0){return e=void 0===e?this.closestPointToPointParameter(t,i):e,this.delta(n).multiplyScalar(e).add(this.points[0])}delta(){return n.subVectors(this.points[1],this.points[0])}}var a=function(t,e){e={};var i={};return t.setEventState=function(t,e){i[t]=e},t.getEventState=function(t){return!1!==i[t]},t._tmpEventMode=!1,Object.defineProperties(t,{tmpEventMode:{get:function(){return t._tmpEventMode},set:function(e){t._tmpEventMode=e,e||t.tmpEvents&&(t.tmpEvents.forEach((t=>t())),t.tmpEvents.length=0,delete t.tmpEvents)}}}),t.on=function(i,o){var s=[].concat(i);function n(){s.forEach((e=>{t.off(e,o)}))}return s.forEach((t=>{(e[t]=e[t]||[]).push(o)})),t.tmpEventMode&&(t.tmpEvents||(t.tmpEvents=[]),t.tmpEvents.push(n)),n},t.getHandlers=function(t){return t?e[t]:e},t.clearHandlers=function(t){t?(e[t]={},delete i[t]):(e={},i={})},t.once=function(e,i){function o(){i.apply(t.off(e,o),arguments)}return o.h=i,t.on(e,o)},t.off=function(o,s){for(var n=e[o],r=0;s&&n&&n[r];r++)n[r]!=s&&n[r].h!=s||n.splice(r--,1);return s||(delete e[o],delete i[o]),t},t.emit=function(o){if(!1===i[o])return t;t.__events||(t.__events={}),t.__events[o]=o;for(var s=e[o],n=0;s&&s[n];)s[n++].apply(t,s.slice.call(arguments,1));return t},t};const h=new om.thr.Vector3(0,0,1);t.CoordProjection=class{constructor(t,e,i){i||(i=[0,0,0]),this.map_center=(new om.thr.Vector3).fromArray(i),t&&e&&(this.real_points=t,this.map_points=e,this.map_points.center=this.arraySub(e.center,i),this.map_points.x_pos=this.arraySub(e.x_pos,i),this.init())}arraySub(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]}arrayToVectors(){this.real_points.center=(new om.thr.Vector3).fromArray(this.real_points.center),this.real_points.x_pos=(new om.thr.Vector3).fromArray(this.real_points.x_pos),this.map_points.center=(new om.thr.Vector3).fromArray(this.map_points.center),this.map_points.x_pos=(new om.thr.Vector3).fromArray(this.map_points.x_pos)}getMatrixAndLength(t){let e=t.x_pos.clone().sub(t.center),i=e.length();e.normalize();let o=h.clone().cross(e).normalize(),s=(new om.thr.Matrix4).makeBasis(e,o,h);return s.setPosition(t.center),{matrix:s,len:i}}init(){this.arrayToVectors();let t=this.getMatrixAndLength(this.real_points),e=this.getMatrixAndLength(this.map_points),i=e.len/t.len;this.real_mat=t.matrix,this.map_mat=e.matrix.scale(new om.thr.Vector3(i,i,i)),this.real_to_map_mat=(new om.thr.Matrix4).getInverse(t.matrix),this.map_inverse_mat=(new om.thr.Matrix4).getInverse(e.matrix)}realToMap(t,e){let i=new om.thr.Vector3(t,e,0);return i.applyMatrix4(this.real_to_map_mat).applyMatrix4(this.map_mat),i}mapToReal(t,e){return new om.thr.Vector3(t,e,0).applyMatrix4(this.map_inverse_mat).applyMatrix4(this.real_mat)}},t.Navigator=class{constructor(t,e,i={}){this.map=t,a(this),this.options=Object.assign({followPosition:!0,followDirection:!0,autoChangeFloor:!0,zoom:100,zoomOutOnComplete:!0,offsetDistance:5,newPathDistance:10,idleTime:3e3,completeDistance:3},i),this.isStart=!1,this.segmentsDict=null,this.segments=null,this.isChangingFloor=!1,this.currentFloorNumber=null,this.routeDescription=null,this.__to_id=null,e&&this.setRouteResult(e),this.off=this.map.on("focusFloors",(t=>{this.segmentsDict&&(this.segments=this.segmentsDict[t[0]]),this.isChangingFloor=!1,this.emit("focusFloors",t)})),this.isMouseDown=!1;let o=null;this.startToPickOff=this.map.on("startPick",(()=>{this.map.view.stopMoveTo(),clearTimeout(o),this.isMouseDown=!0})),this.endToPickOff=this.map.on("endPick",(()=>{o=setTimeout((()=>{this.isMouseDown=!1}),this.options.idleTime)})),console.log("Navigator",this)}on(t,e){}get building(){return this.map.omScene&&this.map.omScene.buildingNode.children.length?this.map.omScene.buildingNode.children[0]:null}get floorNumber(){return this.building?.currentFocus[0]}setRouteResult(t){this.routeResult=[].concat(t),this.routeDescription=e(this.routeResult),console.log("routeDescription: ",this.routeDescription),this.segmentsDict={},this.segments=null,this.routeResult.forEach(((t,e)=>{if("crossLines"!==t.type){var i=[],o=t.vectors[0];o.forEach(((t,e)=>{e<o.length-1&&i.push(new r(o[e],o[e+1],e))})),this.segmentsDict[t.floorNumber]=i}}))}findClosestSegment(t,e){let i=this;return e&&(i={segments:e}),om.Route.prototype.findClosestSegment.call(i,t)}changeFloor(t){return this.isChangingFloor=!0,this.emit("changeFloor",t),this.building.focusFloors(t).then((()=>{this.isChangingFloor=!1}))}start(){if(!this.routeResult)return void console.log("please set route result first!");let t=this.building.currentFocus[0],e=this.routeDescription[0].floorNumber;this.building&&t!==e&&this.changeFloor(e);const i=this.routeDescription[0][0],o=i.position.clone();let s=this.building.getFloorByFloorNumberSync(e);s&&(o.z=s.getHeight()+.3),this.setViewTo(o,i.angle,this.options.zoom),this.isStart=!0,this.emit("start")}setViewTo(t,e,i=100){let o={viewCenter:t,polarAngle:25,zoom:i,easing:"linear",duration:1200};this.options.followDirection&&(o.viewAngle=e),this.map.view.moveTo(o)}update(t,e){if(!this.isStart)return;if(this.isChangingFloor)return;let i=this.routeResult.find((t=>t.floorNumber===e));this.segments||(this.segments=this.segmentsDict[this.routeDescription[0].floorNumber]);let o=t.clone();o.z=0;var s=this.findClosestSegment(o),n=s.segment.index,r=s.endpoint||s.pedal,a=s.distance,[h,l]=this.getDescriptionByIndex(n),u=r.distanceTo(l.position),c=r.distanceTo(h.position);if(!this.isMouseDown&&this.options.followPosition&&this.setViewTo(t,h.angle,this.options.zoom),a>this.options.newPathDistance)this.emit("navi-new-path");else if(a>this.options.offsetDistance)this.emit("navi-return-to-line");else if(clearTimeout(this.__to_id),this.__to_id=setTimeout((()=>{let t=this.getPassRatioByPoint(o,n);i?.lines?.[0]&&(i.lines[0].entity.material.passRatio=t)}),300),("terminal"===l.type||"changeFloor"===l.type)&&u<this.options.completeDistance)"changeFloor"===l.type?this.changeFloor(l.floorNumber):(this.building.clearRoutes(),this.options.zoomOutOnComplete?this.zoomOut(!0):this.dispose(),this.emit("navi-complete"));else{var m=c.toFixed(1),p=u.toFixed(1);let e="";if("changeFloor"===l.type)e=`${p}米后乘梯去往${l.floorNumber}层`;else{var f=m<2?"向"+h.text:"",g=p<1.8?f="":`步行${p}米后`;e=`${f}${g}${""+("终点"===l.text?"到达终点":l.text+"转")}`}this.emit("walk",{text:h.text,remain:+u.toFixed(1),leave:+c.toFixed(1),nextText:l.text,position:t,linePoint:r,description:e,distance:a,next:l})}}zoomOut(t){return new Promise(((e,i)=>{this.building.getFloorByFloorNumber(this.floorNumber).then((e=>{om.utils.focusObject(this.map,e.entity,null,1e3),t&&this.dispose()}))}))}getDescriptionByFloorNumber(t){let e=this.routeDescription.find((e=>e.floorNumber===t));return e||(e=this.routeDescription[0]),e}getDescriptionByIndex(t){var e=this.getDescriptionByFloorNumber(this.floorNumber);if(e)for(var i=0;i<e.length;i++){var o=e[i];if(void 0===o.index)return[o,e[e.length-1]];if(t<o.index)return[e[i-1],o]}}getPassRatioByPoint(t,e){if(!this.segments)return 0;let i=this.segments.reduce(((t,e)=>t+e.length),0),o=0;this.segments.length;for(var s=0;s<e;s++)o+=this.segments[s].length;return(o+this.segments[e].points[0].distanceTo(t))/i}dispose(){clearTimeout(this.__to_id),this.off(),this.startToPickOff(),this.endToPickOff(),this.isStart=!1,this.routeDescription=null,this.routeResult=null,this.segments=null}},t.createNaviMarker=function(t,e,i=40){var o={type:"poi",position:[0,0,0],anchor:"bottom",autoHide:!1,content:{image:{url:e,width:40,height:40}}},s=new om.SpriteMarkerNode(t,o);return s.entity.material.depthTest=!1,s.show=!1,t.omScene.add(s),s},t.createNaviPointer=function(t,e,i=50){let o=new om.PlaneMarkerNode(t,{url:e,size:[i,i],fixedSize:!0,position:[-1e4,-1e4,.6]});return t.omScene.add(o),o}}));
